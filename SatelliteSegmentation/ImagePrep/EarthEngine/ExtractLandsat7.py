from geetools import batch
import ee
import time

# Given a geometry point this returns a 1km (polygon) tile
# with the given point being the bottom left corner
def getCoord(feature):

  x1 = feature.geometry().coordinates().get(0)
  y1 = feature.geometry().coordinates().get(1)


  x2 = ee.Number(0.01364).add(x1)
  y2 = ee.Number(0.01364).add(y1)

  sliding_geometry = ee.Geometry.Polygon([[
  [x1, y1],
  [x2, y1],
  [x2, y2],
  [x1, y2],
  ]]);

  return ee.Feature(sliding_geometry)

# Given a polygon geometry this returns a clipped
# Landsat 7 image of that geometry
def getImages(feature):
  geo = ee.Geometry.Polygon(feature.geometry().coordinates().get(0))
  centroid = feature.geometry().centroid();

  image = ee.ImageCollection('LANDSAT/LE07/C01/T1').filterDate('2000-10-01', '2001-04-01').filterBounds(geo).sort('CLOUD_COVER', True).first(); # September -> April

  image = image.clip(geo)

  return ee.Image(image)

def getBGR (image):
  return image.select(['B1', 'B2', 'B3'])

# Given a biomes geometry this function will extract either the NDVI
# data or the BGR images - based on the flag BGR_images - for each
# tile in the image
def getBiomeImage(biomeGeometry, geometry_colour, biome, BGR_images, i):

    # Add geomtry area to Google Earth Engine
    #Map.addLayer(biomeGeometry, {color: geometry_colour}, biome);

    random_points = 1;

    # Get Feature Collection of random points within biome geometry
    random_points_FC = ee.FeatureCollection.randomPoints(biomeGeometry, random_points, i, 10)

    #Map.addLayer(random_points_FC);

    geometries = random_points_FC.map(getCoord)

    images = ee.ImageCollection(geometries.map(getImages, True))

    # If BGR_images flag is false then extract NDVI data from each image tile
    if (not BGR_images):

        withNDVI = images.map(addNDVI);

        """ TO ADD EACH NDVI IMAGE TO THE MAP
        ndviParams = {min: -1, max: 1, palette: ['blue', 'white', 'green']}

        Map.addLayer(withNDVI.select('NDVI'),
                 {min: -1, max: 1, palette: ['blue', 'white', 'green']},
                 'NDVI classification');
        """

        meanNDVIs = ee.FeatureCollection(withNDVI.map(meanNDVI))

        return meanNDVIs

    else:

        imagesBGR = images.map(getBGR);

        return imagesBGR.first();

# Export the given image to the Google drive in the
# folder named folder with the given file name
def export(image, folder, fileName):

    task = ee.batch.Export.image.toDrive(image=image,
                                     folder=folder,
                                     fileNamePrefix=str(fileName))
    task.start()

    status = task.status()['state']

    while (status != 'COMPLETED' and status != 'FAILED'):

        status = task.status()['state']

        print ("BIOME: " + folder + "\tIMAGE: "+ str(fileName) + "\tSTATUS: " + str(status))

        time.sleep(10)


# Creates N many images for each biome and exports them
# to the google drive
def main():

    N = 2

    for i in range(0,N):

        geometryTrainCER = geometryCER().difference(geometryTestCER(), 10);
        geometryTrainAMA = geometryAMA().difference(geometryTestAMA(), 10);
        geometryTrainCAT = geometryCAT().difference(geometryTestCAT(), 10);

        biomeCaatinga = getBiomeImage(geometryTrainCAT, '32a83a', 'Caatinga', True, i)
        biomeCerrado = getBiomeImage(geometryTrainCER, '324ca8', 'Cerrado', True, i)
        biomeAmazonia = getBiomeImage(geometryTrainAMA, 'FF0000', 'Amazonia', True, i)

        #help(batch.Export.imagecollection.toDrive)

        export(biomeCaatinga, 'Caatinga', i)
        export(biomeCerrado, 'Cerrado', i)
        export(biomeAmazonia, 'Caatinga', i)

# Geometry for Caatinga biome
def geometryCAT():
    return ee.Geometry.Polygon(
        [[[-42.05826377771528, -15.854757940174075],
          [-40.65201377771528, -15.89702702328183],
          [-40.69595909021528, -14.79520738192892],
          [-39.11392784021528, -14.752714929835435],
          [-39.59732627771528, -12.446375440802163],
          [-38.36685752771528, -12.489284406524968],
          [-37.18033409021528, -10.702856490573197],
          [-36.30142784021528, -10.09773308477402],
          [-36.21353721521528, -8.884131303332929],
          [-35.19180869959028, -8.884131303332929],
          [-34.92813682459028, -7.666498211221274],
          [-35.12589073084028, -6.598185200158663],
          [-35.56534385584028, -5.275999997841332],
          [-37.05948448084028, -5.133766672625146],
          [-37.76260948084028, -4.663081322808359],
          [-39.82803916834028, -3.095685481006172],
          [-42.21207237146528, -3.084715128060662]]]);

# Geometry for Cerrado biome
def geometryCER():
    return ee.Geometry.Polygon(
        [[[-43.253135518651106, -5.021111684508034],
          [-44.439658956151106, -5.371228868634882],
          [-44.835166768651106, -6.507654397388285],
          [-45.714073018651106, -6.507654397388285],
          [-45.758018331151106, -8.555153211290122],
          [-47.164268331151106, -8.511694397794136],
          [-47.032432393651106, -10.418870149845777],
          [-48.922080831151106, -10.591704899583325],
          [-48.746299581151106, -11.54051384001206],
          [-50.416221456151106, -11.712688302848527],
          [-50.767783956151106, -14.32420258612824],
          [-55.030479268651106, -14.409344617736894],
          [-55.030479268651106, -16.86362641591061],
          [-55.118369893651106, -19.244969065102573],
          [-57.579307393651106, -19.20347426484414],
          [-57.491416768651106, -21.95954148057466],
          [-56.348838643651106, -21.673957079992284],
          [-55.338096456151106, -22.000292631391275],
          [-55.294151143651106, -22.893825804598848],
          [-50.690879659276106, -22.863459691178388],
          [-50.602989034276106, -24.912533777822745],
          [-48.087119893651106, -24.892604026445238],
          [-48.12271690271528, -23.58325374834716],
          [-46.80435752771528, -23.58325374834716],
          [-46.76041221521528, -21.51352125209363],
          [-45.22232627771528, -21.67696382469707],
          [-45.22232627771528, -20.611328719824495],
          [-43.77213096521528, -20.611328719824495],
          [-43.77213096521528, -19.5795967364699],
          [-42.80533409021528, -19.538187162485723],
          [-42.89322471521528, -3.1395657527972243]]]);

# Geometry for Amazonia biome
def geometryAMA():
    return ee.Geometry.Polygon(
        [[[-64.5666120811511, -11.066493499251933],
          [-60.523643331151106, -11.15273707517923],
          [-59.644737081151106, -10.807611138266022],
          [-56.832237081151106, -10.807611138266022],
          [-56.700401143651106, -11.238955065551924],
          [-54.854698018651106, -11.497453648969081],
          [-53.843955831151106, -11.583567424204649],
          [-53.800010518651106, -12.657692002652746],
          [-52.745323018651106, -12.743432145058614],
          [-52.701377706151106, -9.81320317254805],
          [-51.295127706151106, -9.856502671467135],
          [-51.251182393651106, -7.902764098698903],
          [-49.800987081151106, -7.859233851221025],
          [-49.757041768651106, -4.889768555297202],
          [-46.812705831151106, -4.802192113984373],
          [-46.812705831151106, -3.9696837263465303],
          [-45.186729268651106, -3.7504557622598402],
          [-45.274619893651106, -2.2144994155120714],
          [-50.767783956151106, -0.19356623187742772],
          [-51.339073018651106, 3.583391914910464],
          [-52.613487081151106, 1.7836842831804605],
          [-55.250205831151106, 1.827607774007858],
          [-56.876182393651106, 1.4322607731300514],
          [-58.502158956151106, 1.080783362408126],
          [-59.600791768651106, 1.3443959573873827],
          [-60.128135518651106, 2.162163647164861],
          [-60.128135518651106, 3.040155691349771],
          [-59.864463643651106, 4.136617699689834],
          [-60.347862081151106, 4.399558110676168],
          [-60.303916768651106, 5.012715322006051],
          [-60.875205831151106, 4.530993857471111],
          [-62.149619893651106, 3.96127525211753],
          [-62.633018331151106, 3.6104804939931237],
          [-64.0832136436511, 3.8735899888115704],
          [-63.907432393651106, 2.776823698318261],
          [-63.248252706151106, 2.6451353368034516],
          [-63.336143331151106, 1.7668890829160742],
          [-65.3576277061511, 0.4048611400838265],
          [-66.3683698936511, 0.5366925982296809],
          [-67.6427839561511, 1.9425781718249597],
          [-69.4884870811511, 1.6790382027792001],
          [-69.4884870811511, 1.1518572250745795],
          [-68.7853620811511, 1.0639830399459438],
          [-68.8293073936511, 0.31697226743362433],
          [-69.8400495811511, 0.3609168099149286],
          [-69.0050886436511, -0.825575671604701],
          [-69.8839948936511, -4.687553688980184],
          [-72.6086042686511, -5.387958122859675],
          [-73.2238386436511, -7.091607643909578],
          [-72.4328230186511, -9.136248182452052],
          [-71.6418073936511, -9.699834262497767],
          [-70.3673933311511, -9.136248182452052],
          [-70.3673933311511, -10.478611364805767],
          [-68.4337995811511, -10.478611364805767],
          [-65.2257917686511, -9.353120640758235]]]);

# Returns the test area of the CERRADO biome
def geometryTestCER():
    return ee.Geometry.MultiPolygon(
        [[[[-45.67633752945244, -6.523226072865373],
           [-45.67633752945244, -6.861481125809318],
           [-42.81989221695244, -6.861481125809318],
           [-42.81989221695244, -6.523226072865373]]],
         [[[-44.00641565445244, -6.283034795864718],
           [-44.00641565445244, -6.3048750124011015],
           [-43.96247034195244, -6.3048750124011015],
           [-43.96247034195244, -6.283034795864718]]],
         [[[-45.54713973835905, -12.771249526456705],
           [-45.54713973835905, -13.79769956969344],
           [-42.80055770710905, -13.79769956969344],
           [-42.80055770710905, -12.771249526456705]]],
         [[[-50.56789169148405, -13.883038367245957],
           [-50.56789169148405, -15.116832666062443],
           [-46.25026473835905, -15.116832666062443],
           [-46.25026473835905, -13.883038367245957]]],
         [[[-55.03057408152428, -15.554198085749734],
           [-55.03057408152428, -17.439697396410782],
           [-51.41607212839928, -17.439697396410782],
           [-51.41607212839928, -15.554198085749734]]],
         [[[-46.197878891424025, -15.60616497703185],
           [-46.197878891424025, -17.344403434471907],
           [-42.836062485174025, -17.344403434471907],
           [-42.836062485174025, -15.60616497703185]]],
         [[[-50.482546860174025, -17.459721681114218],
           [-50.482546860174025, -19.024788129811263],
           [-49.032351547674025, -19.024788129811263],
           [-49.032351547674025, -17.459721681114218]]],
         [[[-46.97393990153202, -19.140238524532997],
           [-46.97393990153202, -21.509552002000092],
           [-45.21612740153202, -21.509552002000092],
           [-45.21612740153202, -19.140238524532997]]],
         [[[-53.01642037028202, -21.693416944209496],
           [-53.01642037028202, -22.852386157665716],
           [-50.86310005778202, -22.852386157665716],
           [-50.86310005778202, -21.693416944209496]]]])

def geometryTestAMA():
    return ee.Geometry.MultiPolygon(
        [[[[-62.93891259006722, 2.9666985508388692],
           [-62.93891259006722, 1.737290055554281],
           [-60.91742821506722, 1.737290055554281],
           [-60.91742821506722, 2.9666985508388692]]],
         [[[-68.43207665256722, -0.23998203643624655],
           [-68.43207665256722, -1.51422050290123],
           [-66.45453759006722, -1.51422050290123],
           [-66.45453759006722, -0.23998203643624655]]],
         [[[-65.97113915256722, -2.524321938320355],
           [-65.97113915256722, -3.6213582746053423],
           [-63.20258446506722, -3.6213582746053423],
           [-63.20258446506722, -2.524321938320355]]],
         [[[-62.89496727756722, -0.28392688856785614],
           [-62.89496727756722, -1.4702900953471383],
           [-60.43402977756722, -1.4702900953471383],
           [-60.43402977756722, -0.28392688856785614]]],
         [[[-60.49994774631722, -1.5581500200932992],
           [-60.49994774631722, -2.480418532433884],
           [-57.489693840067225, -2.480418532433884],
           [-57.489693840067225, -1.5581500200932992]]],
         [[[-57.489693840067225, 0.22144249182973066],
           [-57.489693840067225, -1.4702900953471383],
           [-55.204537590067225, -1.4702900953471383],
           [-55.204537590067225, 0.22144249182973066]]],
         [[[-55.182564933817225, -1.51422050290123],
           [-55.182564933817225, -2.6560231546524102],
           [-52.216256340067225, -2.6560231546524102],
           [-52.216256340067225, -1.51422050290123]]],
         [[[-52.172311027567225, -3.1826806606475593],
           [-52.172311027567225, -4.979795049999769],
           [-50.018990715067225, -4.979795049999769],
           [-50.018990715067225, -3.1826806606475593]]],
         [[[-55.380318840067225, -5.417439440660732],
           [-55.380318840067225, -6.728371051292028],
           [-52.216256340067225, -6.728371051292028],
           [-52.216256340067225, -5.417439440660732]]],
         [[[-57.401803215067225, -3.358175563195173],
           [-57.401803215067225, -4.936014161601338],
           [-55.468209465067225, -4.936014161601338],
           [-55.468209465067225, -3.358175563195173]]],
         [[[-60.56586571506722, -5.417439440660732],
           [-60.56586571506722, -6.553769341375657],
           [-57.577584465067225, -6.553769341375657],
           [-57.577584465067225, -5.417439440660732]]],
         [[[-63.11469384006722, -6.597425564168869],
           [-63.11469384006722, -8.427206149062133],
           [-60.60981102756722, -8.427206149062133],
           [-60.60981102756722, -6.597425564168869]]],
         [[[-63.20258446506722, -4.278968336641209],
           [-63.20258446506722, -5.11112012523237],
           [-60.60981102756722, -5.11112012523237],
           [-60.60981102756722, -4.278968336641209]]],
         [[[-66.52045555881722, -5.570541429150232],
           [-66.52045555881722, -6.597425564168869],
           [-63.15863915256722, -6.597425564168869],
           [-63.15863915256722, -5.570541429150232]]],
         [[[-69.17914696506722, -6.684726444118588],
           [-69.17914696506722, -8.383732881356803],
           [-66.54242821506722, -8.383732881356803],
           [-66.54242821506722, -6.684726444118588]]],
         [[[-57.313912590067225, -6.553769341375657],
           [-57.313912590067225, -7.992257631675836],
           [-55.424264152567225, -7.992257631675836],
           [-55.424264152567225, -6.553769341375657]]],
         [[[-55.116646965067225, -9.85893701755846],
           [-55.116646965067225, -11.370656007089115],
           [-53.183053215067225, -11.370656007089115],
           [-53.183053215067225, -9.85893701755846]]]])


def geometryTestCAT():
    return ee.Geometry.MultiPolygon(
        [[[[-41.70686523512515, -4.049470622588458],
           [-41.70686523512515, -4.8381020204549925],
           [-40.78401367262515, -4.8381020204549925],
           [-40.78401367262515, -4.049470622588458]]],
         [[[-39.72932617262515, -4.180966625840401],
           [-39.72932617262515, -4.794311873347587],
           [-38.98225586012515, -4.794311873347587],
           [-38.98225586012515, -4.180966625840401]]],
         [[[-40.84993164137515, -5.319601104255898],
           [-40.84993164137515, -6.019282264689124],
           [-39.75129882887515, -6.019282264689124],
           [-39.75129882887515, -5.319601104255898]]],
         [[[-38.93831054762515, -5.36335558610289],
           [-38.93831054762515, -5.975577484283064],
           [-37.90559570387515, -5.975577484283064],
           [-37.90559570387515, -5.36335558610289]]],
         [[[-36.69709961012515, -5.450855114339314],
           [-36.69709961012515, -5.931869214034764],
           [-35.97200195387515, -5.931869214034764],
           [-35.97200195387515, -5.450855114339314]]],
         [[[-41.50911132887515, -6.630768692358324],
           [-41.50911132887515, -7.45941817328575],
           [-40.84993164137515, -7.45941817328575],
           [-40.84993164137515, -6.630768692358324]]],
         [[[-39.57551757887515, -6.739884940823748],
           [-39.57551757887515, -7.394053197001618],
           [-38.82844726637515, -7.394053197001618],
           [-38.82844726637515, -6.739884940823748]]],
         [[[-37.66389648512515, -6.5871154056533525],
           [-37.66389648512515, -7.285090103208559],
           [-36.82893554762515, -7.285090103208559],
           [-36.82893554762515, -6.5871154056533525]]],
         [[[-41.81672851637515, -8.547333167104387],
           [-41.81672851637515, -9.502150163939856],
           [-40.58625976637515, -9.502150163939856],
           [-40.58625976637515, -8.547333167104387]]],
         [[[-38.96028320387515, -8.590787916345507],
           [-38.96028320387515, -9.458805067236105],
           [-37.92756836012515, -9.458805067236105],
           [-37.92756836012515, -8.590787916345507]]],
         [[[-40.69612304762515, -9.93529532332042],
           [-40.69612304762515, -10.886164797788856],
           [-39.61946289137515, -10.886164797788856],
           [-39.61946289137515, -9.93529532332042]]],
         [[[-41.88264648512515, -11.3604807569772],
           [-41.88264648512515, -12.435493624427199],
           [-40.82795898512515, -12.435493624427199],
           [-40.82795898512515, -11.3604807569772]]],
         [[[-35.77424804762515, -7.720779620929262],
           [-35.77424804762515, -8.19951888745974],
           [-35.29084961012515, -8.19951888745974],
           [-35.29084961012515, -7.720779620929262]]],
         [[[-37.77493324863537, -9.833050500346669],
           [-37.77493324863537, -10.589906054764864],
           [-37.09378090488537, -10.589906054764864],
           [-37.09378090488537, -9.833050500346669]]],
         [[[-41.81790199863537, -13.618785368937216],
           [-41.81790199863537, -14.556493607538803],
           [-40.98294106113537, -14.556493607538803],
           [-40.98294106113537, -13.618785368937216]]],
         [[[-40.08206215488537, -13.661491248246142],
           [-40.08206215488537, -14.450131338837021],
           [-39.48880043613537, -14.450131338837021],
           [-39.48880043613537, -13.661491248246142]]],
         [[[-35.90725746738537, -6.440338433231299],
           [-35.90725746738537, -6.745920835099299],
           [-35.53372231113537, -6.745920835099299],
           [-35.53372231113537, -6.440338433231299]]],
         [[[-37.53323402988537, -7.879186808324277],
           [-37.53323402988537, -8.162036848417857],
           [-36.96194496738537, -8.162036848417857],
           [-36.96194496738537, -7.879186808324277]]],
         [[[-40.45559731113537, -7.726802414036152],
           [-40.45559731113537, -8.140286172224913],
           [-39.84036293613537, -8.140286172224913],
           [-39.84036293613537, -7.726802414036152]]],
         [[[-39.287588748865204, -11.403680919736978],
           [-39.287588748865204, -12.177999762889632],
           [-38.276846561365204, -12.177999762889632],
           [-38.276846561365204, -11.403680919736978]]]])

if __name__ == "__main__":

    #ee.Authenticate()

    ee.Initialize()

    main()
